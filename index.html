<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猜词</title>
    <link rel="stylesheet" href="./css/element-index.css">
    <link rel="manifest" href="/manifest.json">
    <script src="./scripts/vue.global.js"></script>
    <script src="./scripts/element-plus/index.full.js"></script>
    <script src="./scripts/element-plus/zh-cn.js"></script>
    <script src="./scripts/element-plus/icons-vue.js"></script>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
<div id="app">
    <h1>测试重力</h1>
    <button onclick="requestPermission()">请求重力感应权限</button>
    <p id="orientationOutput">等待设备方向信息...</p>
    <p id="beta"></p>
    <el-button @click="startGame">开始游戏</el-button>
    <el-button @click="nextWord(false)">下一个</el-button>
    <el-button @click="startListening">开始监听</el-button>
    <el-button @click="stopListening">停止监听</el-button>
    <div class="word-card">
        <p>{{ wordList[currentId] }}</p>
    </div>
</div>
<script>
    const { createApp, reactive, ref, computed, onMounted, nextTick } = Vue;
    const { ElButton, ElCard, ElIcon, ElMessage } = ElementPlus;
    const app =  createApp({
        setup() {
            const deviceOrientation = ref(-1);
            const currentId = ref(0);
            const errorList = ref([]);
            const correctList = ref([]);
            const wordList = ref(['苹果', '香蕉', '樱桃', '枣', '黑莓', '无花果', '葡萄', '哈密瓜']);

            function requestPermission() {
                if (typeof DeviceOrientationEvent !== 'undefined' &&
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                console.log('game start!');
                                ElMessage.success("开始游戏！");
                                // startGuess();
                            } else {
                                ElMessage.error("方向传感器权限被拒绝！");
                                console.log('permission denied.');
                            }
                        })
                        .catch((err) => {
                            console.error("permission failed:", err);
                        });
                } else {
                    ElMessage.error('当前设备或浏览器不支持方向传感器！');
                    console.log('DeviceOrientationEvent not supported.');
                }
            }

            const startGuess = () => {
                ElMessage.warning('请将设备垂直，屏幕面向自己！');
                deviceOrientation.value = -1; // 初始化设备方向
                startListening();
                while (deviceOrientation.value !== 0) {
                    // 等待设备垂直
                }
                stopListening();
                ElMessage.success('设备垂直，开始猜谜！');
            }


            const startGame = () => {
                console.log('game init...');
                ElMessage.warning('正在初始化...')
                currentId.value = 0;
                errorList.value = [];
                correctList.value = [];
                ElMessage.warning('正在获取必要权限');
                requestPermission();
            }
            const nextWord = (isCorrect) => {
                const correctHint = isCorrect?'correct':'error';
                console.log('this word:[' + currentId.value + ']' + wordList.value[currentId.value] + ' which is ' + correctHint);
                if (isCorrect) {
                    correctList.value.push(currentId.value);
                } else {
                    errorList.value.push(currentId.value);
                }
                console.log('correctList:',correctList.value);
                console.log('errorList:',errorList.value);
                if (currentId.value < wordList.value.length) {
                    currentId.value++;
                } else {
                    console.log('没有更多词语了!');
                }
            }

            let deviceOrientationHandler = function (event) {
                let beta = event.beta; // 获取设备的 beta 角度
                if (beta >= 55 && beta <= 125) {
                    deviceOrientation.value = 0;
                    // ElMessage.info('等待中');
                    // startListening();
                    // document.getElementById('orientationOutput').innerHTML = "设备处于垂直状态（等待）";
                } else if (beta > 125) {
                    deviceOrientation.value = 1;
                    // ElMessage.success('正确！');
                    // stopListening();
                    // document.getElementById('orientationOutput').innerHTML = "设备向前翻转（正确）";
                } else if (beta < 55) {
                    deviceOrientation.value = 2;
                    // ElMessage.error('错误！');
                    // stopListening();
                    // document.getElementById('orientationOutput').innerHTML = "设备向后翻转（错误）";
                }
                //document.getElementById('beta').innerHTML = beta.toFixed(2);
            };

            function startListening() {
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', deviceOrientationHandler, false);
                }
            }

            function stopListening() {
                window.removeEventListener('deviceorientation', deviceOrientationHandler);
            }

            return {
                currentId,
                deviceOrientation,
                errorList,
                correctList,
                wordList,
                nextWord,
                startGame,
                startListening,
                stopListening,
            };
        }
    });
    for ([name, comp] of Object.entries(ElementPlusIconsVue)) {
        app.component(name, comp);
    }
    app.use(ElementPlus, { locale: ElementPlusLocaleZhCn });
    app.mount('#app');
</script>

</body>
</html>